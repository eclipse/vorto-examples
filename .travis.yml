sudo: required
dist: trusty

language: java

services:
  - docker

jdk: oraclejdk8

cache:
  directories:
    - '$HOME/.m2/repository'

before_install:
  - echo "MAVEN_OPTS='-Xms1g -Xmx2g'" > ~/.mavenrc

install:
  - "echo 'installing awscli'"
  - pip install --user awscli

script:
  - cd vorto-generators
  - mvn -q clean install
  - if [ -n "$TRAVIS_TAG" ]; then
    docker build --build-arg JAR_FILE=./generator-runner/target/generator-runner-3rd-party-exec.jar -f docker/Generators_Dockerfile -t eclipsevorto/vorto-generators-3rd-party:latest .;
    docker build --build-arg JAR_FILE=./generator-runner/target/generator-runner-3rd-party-exec.jar -f docker/Generators_Dockerfile -t eclipsevorto/vorto-generators-3rd-party:$TRAVIS_TAG .;
    fi;
  # export the aws keys
  - export TRAVIS_COMMIT_SHORT=$(git rev-parse --short HEAD)
  - export ELASTIC_BEANSTALK_LABEL="${TRAVIS_JOB_NUMBER}_${TRAVIS_COMMIT_SHORT}"
  - export ELASTIC_BEANSTALK_DESCRIPTION="Build ${TRAVIS_JOB_NUMBER} - Git Revision ${TRAVIS_COMMIT_SHORT} example-generator-exec.jar"

before_deploy:
  - export AWS_DEFAULT_REGION=$VORTO_S3_REGION
  - export AWS_ACCESS_KEY_ID="$VORTO_AWS_ACCESS_KEY"
  - export AWS_SECRET_ACCESS_KEY="$VORTO_AWS_SECRET_KEY"

deploy:
  - provider: script
    script : bash scripts/create_jar_with_images.sh
    skip_cleanup: true
    on:
      all_branches: true
  - provider: script
    script:
      - aws s3 cp ./aws-upload/example-generator-exec_${ELASTIC_BEANSTALK_LABEL}.jar s3://$VORTO_S3_BUCKET --acl "private" --storage-class "STANDARD_IA" --only-show-errors --no-guess-mime-type
    skip_cleanup: true
    on:
      branch: "master"
  - provider: script
    script:
      - aws elasticbeanstalk create-application-version --application-name "VortoRepoServer" --no-auto-create-application --version-label "build-job_${ELASTIC_BEANSTALK_LABEL}_3rdparty" --description "Build ${TRAVIS_JOB_NUMBER} - Git Revision ${TRAVIS_COMMIT_SHORT}" --source-bundle S3Bucket="$VORTO_S3_BUCKET",S3Key="example-generator-exec_${ELASTIC_BEANSTALK_LABEL}.jar"
    skip_cleanup: true
    on:
      branch: "master"
  - provider: script
    script:
      - aws elasticbeanstalk update-environment --application-name "VortoRepoServer" --environment-name "Vortoexamplegenerators-env-dev" --version-label "build-job_${ELASTIC_BEANSTALK_LABEL}_3rdparty"
    skip_cleanup: true
    on:
      branch: "master"

