sudo: required
dist: trusty

jobs:
  include:
    - stage: deploy
      name: "Publish Vorto-Dashboard to NPM"
      language: node_js
      node_js:
        - '10'
        
      cache:
        yarn: true
        directories:
          - ~/.cache
      
      before_install:
        - cd vorto-dashboard
      
      install:
        - echo "Installing dependencies"
        - yarn install
      
      after_success:
        - echo "Creating build"
        - npm run build
        - npm run dist
        
      before_deploy:
        - cd dist
        
      deploy:
        provider: npm
        skip_cleanup: true
        email: fixed-term.tim.grossmann@sg.bosch.com
        api_key:
          secure: "$NPM_API_TOKEN"
        on:
          branches:
            only:
              - patch-4
  
  
    - stage: deploy
      name: "Deploy Generators"
      language: java
      jdk: oraclejdk8

      services:
        - docker
        
      cache:
        directories:
          - '$HOME/.m2/repository'

      before_install:
        - echo "MAVEN_OPTS='-Xms1g -Xmx2g'" > ~/.mavenrc

      install:
        - "echo 'installing awscli'"
        - pip install --user awscli

      script:
        - cd vorto-generators
        - mvn -q clean install
        - if [ -n "$TRAVIS_TAG" ]; then
          docker build --build-arg JAR_FILE=./generator-runner/target/generator-runner-3rd-party-exec.jar -f docker/Generators_Dockerfile -t eclipsevorto/vorto-generators-3rd-party:latest .;
          docker build --build-arg JAR_FILE=./generator-runner/target/generator-runner-3rd-party-exec.jar -f docker/Generators_Dockerfile -t eclipsevorto/vorto-generators-3rd-party:$TRAVIS_TAG .;
          fi;

      before_deploy:
        - export TRAVIS_COMMIT_SHORT=$(git rev-parse --short HEAD)
        - export ELASTIC_BEANSTALK_LABEL="${TRAVIS_JOB_NUMBER}_${TRAVIS_COMMIT_SHORT}"
        - export ELASTIC_BEANSTALK_DESCRIPTION="Build ${TRAVIS_JOB_NUMBER} - Git Revision ${TRAVIS_COMMIT_SHORT} example-generator-exec.jar"

      deploy:
          provider: script
          script : "echo 'deploying generators'"
          skip_cleanup: true
          on:
            branch: patch-4
